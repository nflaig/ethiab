# ethiab - Ethereum in a Box
Ethereum in a Box takes its inspiration from the [excellent article](https://dev.to/q9/how-to-merge-an-ethereum-network-right-from-the-genesis-block-3454) from Afri at ChainSafe, which details how to stand up a local testnet, merged since genesis.  This project takes that a bit further by implementing all of the steps in shell scripts, Docker and Docker Compose files.  Furthermore, we enable the Shapella hardforks from genesis.

## What can Ethereum in a Box be used for?
As of now, mostly just learning how a private Ethereum network is bootstrapped and seeing it go through genesis.  The `genesis.json` file is not setup with any allocations, and the validators have BLS withdrawal credentials at genesis, so there's no ETH to use.  I haven't even tested creating a new account using [Clef](https://geth.ethereum.org/docs/fundamentals/account-management).

The containers run inside a Docker bridge network (172.16.8.0/24).  As of today, none of the container ports are exposed to the host.  This will change in the near future, to allow coodinating with external parties to share in the network bootstrap.

There is a list things of I'm intending to do, curently in this README, soon to be in the Issues tracker.

### A Note About Security
---
**This project is about bootstrapping a private / semi-private Ethereum testnet / devnet. By definition, any Ether associated with these networks will have no value at all.  With that in mind, security best practices have not necessarily been observed and nothing in this project should be referred to for configuring clients for Ethereum mainnet.  We are very clearly putting mnemonics in files, using the password "password" for validator keys, etc.  Never do this.  Let's be careful out there.**

---

### Prerequisites
- Modern Linux shell
  - Developed / tested on `Debian 11`
  - Should work on modern `Ubuntu`
- `Docker` and `Docker Compose`
  - Tested with docker version v24.0.2, docker compose v2.8.1

### Quickstart
1. Clone this repo
2. From the ethiab repo folder, running `docker compose up` will start the clients and countdown about five minutes to genesis, showing you the union of all container logs in the terminal (attached mode).  Running `docker compose up -d` will run all containers detached.
3. If you run in detached mode, to see a particular container logs, run `docker logs -f <containername>`, e.g. `docker logs -f ethiab-vc`, to see the validator client logs
4. To pass additional parameters to the EC, BN, and VC client, edit the `.env` file values.  This can be useful to increase log levels, for example.

### What's Going On Here?

First, if you haven't read Afri's article linked above, you should.  It does a good job of explaining how to get all the necessary pieces going to start up your own Ethereum network on your local machine.  Reading through that article will make everything else make more sense.

The list of steps to get the network going is a great use case for Docker Compose, which is used to orchestrate multiple Docker containers as a group.  We're having to deal with some apps that are already in Docker images, but we also need to clone and build GitHub repos to make some tools work.  As detailed as the article is, there are a lot of steps, and using Compose can make it close to one-step.  Here's an overview of each service:

- **config:** Runs a quick shell script in a `busybox` instance simply to synchronize the genesis start time between the EC `genesis.json` file and BN `config.yaml`.  Set to "now".
- **ec1:** Initializes EC genesis and starts Geth, becomes bootnode for ec2.
- **ec2:** Queries `enode` record from ec1, updates the BoostrapNodes entries in toml file to use ec1 as bootnode, initializes EC genesis and starts Geth.
- **genesis:** Builds and runs a custom `genesis.Dockerfile` which uses `Go` to build `eth2-testnet-genesis`, then runs a shell script to use the tool to generate the `genesis.ssz` file for BN clients
- **staking-deposit:** Builds and runs a custom `staking-deposit.Dockerfile` which uses a `python` image, clones the Ethereum `staking-deposit-cli`, parses the mnemonic.yaml file, and calls the `staking-deposit-cli` with necessary parameters to create the validator keys.
- **bc1:** Starts `lodestar beacon`, using ec1 as its execution client peer.  This container uses a healthcheck, so bc2 waits to start until bc1 is fully up.
- **bc2:** Queries bc1 for its `enr` record, then starts `lodestar beacon`, using bc1 as its bootnode.
- **vc:** Starts `lodestar validator`, using bc1 as its BN client, loads the validator keys generated by the staking-deposit container.

## Contributing

If you see something in this project that can be better, I'm happy to take PRs.  If something doesn't work but you can't fix it, feel free to open an issue and I'll try to take a look.  This is a side project for me, but I'm happy to help as I can.

## TODO:
- Create issues out of the items below:
- Expose ports and configure ec2, bn2 such that we can distribute the enode and enr for external parties to connect to.  Need to set enode / enr ip address to external address.
- Create "peer" mode, to easily stand up external clients / validators that connect to the bootnodes.
- Provide for custom parameters like genesis start, genesis delay, fee recipient, etc.
- Enable generating mnemonic, rather than using static.
- Use sensible default fee recipient, like the first address generated by the mnemonic.
- Enable creation of 0x01 validators, as of now they use BLS withdrawal credentials.
- Add other EC and BN clients beyond Geth and Lodestar.

### Stretch Goals:
- EL / BN explorer containers
